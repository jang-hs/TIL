<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Distributed Job Scheduler system design | Today I Learned</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="desc">
    
    <link rel="preload" href="/TIL/assets/css/0.styles.00bd70e4.css" as="style"><link rel="preload" href="/TIL/assets/js/app.dba3423c.js" as="script"><link rel="preload" href="/TIL/assets/js/2.83a6f128.js" as="script"><link rel="preload" href="/TIL/assets/js/1.322c5a0a.js" as="script"><link rel="preload" href="/TIL/assets/js/29.f2c2a0c0.js" as="script"><link rel="prefetch" href="/TIL/assets/js/10.d9e4b84a.js"><link rel="prefetch" href="/TIL/assets/js/11.ccf2f442.js"><link rel="prefetch" href="/TIL/assets/js/12.7e65a11a.js"><link rel="prefetch" href="/TIL/assets/js/13.d4317b93.js"><link rel="prefetch" href="/TIL/assets/js/14.ea01d868.js"><link rel="prefetch" href="/TIL/assets/js/15.9da1bcf8.js"><link rel="prefetch" href="/TIL/assets/js/16.8727279f.js"><link rel="prefetch" href="/TIL/assets/js/17.fa7fb6b0.js"><link rel="prefetch" href="/TIL/assets/js/18.56419c05.js"><link rel="prefetch" href="/TIL/assets/js/19.42d46c09.js"><link rel="prefetch" href="/TIL/assets/js/20.100d0125.js"><link rel="prefetch" href="/TIL/assets/js/21.428690a9.js"><link rel="prefetch" href="/TIL/assets/js/22.53eda83e.js"><link rel="prefetch" href="/TIL/assets/js/23.377a507c.js"><link rel="prefetch" href="/TIL/assets/js/24.62a43f53.js"><link rel="prefetch" href="/TIL/assets/js/25.2cb61fbc.js"><link rel="prefetch" href="/TIL/assets/js/26.07decc26.js"><link rel="prefetch" href="/TIL/assets/js/27.51b2d4dd.js"><link rel="prefetch" href="/TIL/assets/js/28.86b66102.js"><link rel="prefetch" href="/TIL/assets/js/3.e6df855e.js"><link rel="prefetch" href="/TIL/assets/js/30.33147ece.js"><link rel="prefetch" href="/TIL/assets/js/31.4cd27359.js"><link rel="prefetch" href="/TIL/assets/js/32.a6842c91.js"><link rel="prefetch" href="/TIL/assets/js/33.431c1871.js"><link rel="prefetch" href="/TIL/assets/js/34.53302144.js"><link rel="prefetch" href="/TIL/assets/js/35.d500be46.js"><link rel="prefetch" href="/TIL/assets/js/36.f4e6eb9f.js"><link rel="prefetch" href="/TIL/assets/js/37.eb0597c0.js"><link rel="prefetch" href="/TIL/assets/js/38.bcaf4fbf.js"><link rel="prefetch" href="/TIL/assets/js/39.c64a3043.js"><link rel="prefetch" href="/TIL/assets/js/4.cd02f05a.js"><link rel="prefetch" href="/TIL/assets/js/40.c4adbd8b.js"><link rel="prefetch" href="/TIL/assets/js/41.417973c2.js"><link rel="prefetch" href="/TIL/assets/js/42.c0d1a1f0.js"><link rel="prefetch" href="/TIL/assets/js/5.610977c8.js"><link rel="prefetch" href="/TIL/assets/js/6.b548e5bb.js"><link rel="prefetch" href="/TIL/assets/js/7.08600db3.js"><link rel="prefetch" href="/TIL/assets/js/vendors~docsearch.ef62c33d.js">
    <link rel="stylesheet" href="/TIL/assets/css/0.styles.00bd70e4.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/TIL/" class="home-link router-link-active"><!----> <span class="site-name">Today I Learned</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://github.com/jang-hs" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://github.com/jang-hs" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/TIL/" aria-current="page" class="sidebar-link">Monthly I Learned</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>algorithm</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>data-engineer</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>design-pattern</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/TIL/design-pattern/241030-factory-decorator-pattern.html" class="sidebar-link">팩토리 패턴과 데코레이터 패턴</a></li><li><a href="/TIL/design-pattern/241114-distributed-job-scheduler-system.html" aria-current="page" class="active sidebar-link">Distributed Job Scheduler system design</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/TIL/design-pattern/241114-distributed-job-scheduler-system.html#high-level-system-design" class="sidebar-link">High level system design</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>mlops</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>sql</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="distributed-job-scheduler-system-design"><a href="#distributed-job-scheduler-system-design" class="header-anchor">#</a> Distributed Job Scheduler system design</h1> <p><a href="https://dilipkumar.medium.com/distributed-job-scheduler-system-design-8ae13a8dee83" target="_blank" rel="noopener noreferrer">Distributed Job Scheduler system design<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 를 읽고 정리한 내용입니다.</p> <p>대량의 user-submitted jobs을 확장 가능하고 내결함성 있게 관리, 추적 및 실행할 수 있는 분산 작업 스케줄러를 설계합니다.</p> <h2 id="high-level-system-design"><a href="#high-level-system-design" class="header-anchor">#</a> High level system design</h2> <p>다음은 분산 작업 스케줄러의 고수준 시스템 설계(high level system design)입니다.
<img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*crfre3LahxotOEyH7UQQ5w.png" alt=""></p> <p>각 서비스를 자세히 살펴보겠습니다.</p> <h3 id="job-submission-service"><a href="#job-submission-service" class="header-anchor">#</a> Job Submission Service</h3> <p>Job submission service는 <code>Jobs</code> 테이블에 기록합니다. <code>Jobs</code> 테이블의 스키마는 <code>UserId+JobId</code>를 기본 키로, <code>UserId</code>를 샤드 키로 사용합니다.</p> <blockquote><p>샤드 키(shard key)는 분산 시스템에서 데이터를 여러 서버(샤드)에 나누어 저장할 때 데이터를 어떻게 분배할지를 결정하는 기준이 되는 키입니다. 데이터베이스가 수평적으로 확장되기 위해서는 데이터를 여러 샤드로 나누어 저장하는 것이 효율적이며, 이를 통해 시스템의 성능과 처리 용량을 높일 수 있습니다.</p></blockquote> <table><thead><tr><th>UserId</th> <th>JobId</th> <th>IsRecurring</th> <th>Interval</th> <th>MaxRetry</th> <th>CreateTimestamp</th></tr></thead> <tbody><tr><td>1</td> <td>1</td> <td>True</td> <td>0 */2 * * *</td> <td>3</td> <td>t1</td></tr> <tr><td>1</td> <td>2</td> <td>True</td> <td>0 */6 * * *</td> <td>1</td> <td>t2</td></tr> <tr><td>1</td> <td>3</td> <td>True</td> <td>0 0 * * *</td> <td>0</td> <td>t3</td></tr> <tr><td>1</td> <td>4</td> <td>False</td> <td>NULL</td> <td>3</td> <td>t4</td></tr> <tr><td>2</td> <td>5</td> <td>False</td> <td>NULL</td> <td>3</td> <td>t4</td></tr></tbody></table> <p>Job submission은 또한 작업을 분석하고 <code>ScheduledJob</code> 큐에 작업 주기에 따라 TTL을 설정하여 대기열에 추가합니다. <code>ScheduledJob</code>은 다음 스키마를 사용하여 예약된 작업을 저장하며, <code>NextExecutionTimestamp</code>가 샤드 키로 사용됩니다. 타임스탬프 기반 샤드 키는 대기열 시스템이 매 분마다 같은 위치에 있는 작업을 가져오도록 돕습니다.</p> <table><thead><tr><th>NextExecutionTimestamp</th> <th>JobId</th></tr></thead> <tbody><tr><td>T1</td> <td>1</td></tr> <tr><td>T1</td> <td>2</td></tr> <tr><td>T1</td> <td>3</td></tr></tbody></table> <h3 id="scheduler-service"><a href="#scheduler-service" class="header-anchor">#</a> Scheduler Service</h3> <p>스케줄러 서비스는 작업을 실행할 때 다음 두 가지 결정을 내려야 합니다.</p> <ol><li>작업이 주기적(interval)인 경우, 다음 실행 시간을 계산하고 다시 <code>ScheduledJob</code> 큐에 대기시킵니다.</li> <li>작업의 유형, 종속성 등을 분석하고 적절한 워커 노드를 찾아 작업을 실행합니다.</li></ol> <h3 id="workers"><a href="#workers" class="header-anchor">#</a> Workers</h3> <p>작업에 따라 여러 유형의 워커를 사용할 수 있습니다.</p> <h4 id="멱등성-워커-idempotent-workers"><a href="#멱등성-워커-idempotent-workers" class="header-anchor">#</a> 멱등성 워커(Idempotent workers)</h4> <p>분산 시스템에서는 (재시도 등으로 인해) 중복 메시지가 워커에 전달될 수 있습니다. 따라서 워커는 멱등성(idempotency)을 유지해야 합니다. 즉, 두 워커가 동일한 작업을 병렬로 처리하더라도 서로 영향을 주지 않아야 합니다.</p> <h4 id="비멱등성-워커-non-idempotent-workers"><a href="#비멱등성-워커-non-idempotent-workers" class="header-anchor">#</a> 비멱등성 워커(Non idempotent workers)</h4> <p>일부 작업은 특성상 여러 워커가 동일한 작업을 동시에 처리하지 않도록 해야 합니다. 이 경우 워커는 외부 저장소를 참조해 작업 진행 상태를 확인하고, 처리 중인지 확인하여 필요에 따라 작업을 계속하거나 중단합니다.
<img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*esM2mNiwylnfBzjJ9g6v3g.png" alt=""></p> <h4 id="단기-작업-short-running-job"><a href="#단기-작업-short-running-job" class="header-anchor">#</a> 단기 작업(Short running job)</h4> <p>몇 초 안에 완료할 수 있는 단기 작업은 타임아웃 내에서 대기열에 응답할 수 있습니다.</p> <h4 id="장기-작업-long-running-job"><a href="#장기-작업-long-running-job" class="header-anchor">#</a> 장기 작업(Long running job)</h4> <p>일부 작업은 실행에 몇 분 혹은 몇 시간 이상 걸릴 수 있습니다. 대기열 시스템은 이 정도로 오래 기다릴 수 없으므로 이벤트가 타임아웃되어 다른 워커에게 재전달될 수 있으며, 이로 인해 동일한 작업이 여러 워커에서 재처리될 수 있습니다. 장기 작업을 처리하는 여러 방법이 있으며, 작업의 특성에 따라 다릅니다.</p> <ul><li><p><strong>작업 처리 페이징(Paginate the job processing)</strong><br>
작업 범위를 작은 청크로 나누고 페이지 방식으로 처리합니다. 이 접근 방식은 작업을 단기 작업으로 변환합니다. <code>Checkpoint</code> 테이블을 사용해 작업 진행 상태를 확인합니다.</p> <table><thead><tr><th>JobId</th> <th>PageSize</th> <th>PageStart</th> <th>IsCompleted</th></tr></thead> <tbody><tr><td>1</td> <td>10</td> <td>20</td> <td>False</td></tr> <tr><td>2</td> <td>10</td> <td>0</td> <td>False</td></tr> <tr><td>3</td> <td>10</td> <td>100</td> <td>True</td></tr></tbody></table> <p><img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jbrOSm8LezA1qtdPh1O4GA.png" alt=""></p></li> <li><p><strong>장기 실행 작업을 위한 미래 메시지 대기열 추가(Enqueue message for long future)</strong><br>
작업을 작은 청크로 나누기 어려운 경우 <code>JobStatus</code> 테이블을 유지하여 처리 상태를 확인합니다.</p> <table><thead><tr><th>JobId</th> <th>Status</th></tr></thead> <tbody><tr><td>1</td> <td>INPROGRESS</td></tr> <tr><td>2</td> <td>COMPLETED</td></tr></tbody></table></li></ul> <h4 id="재시도-메커니즘-retry-mechanism"><a href="#재시도-메커니즘-retry-mechanism" class="header-anchor">#</a> 재시도 메커니즘(Retry mechanism)</h4> <p>작업의 재시도 옵션에 따라 워커 노드는 메시지를 확인하거나 확인하지 않고 재전송합니다. 재시도가 가능한 작업의 경우 실패 시 메시지를 확인하고, 메시지를 새로 발행하며 재시도를 진행합니다. 재시도가 불가능한 작업은 실패 시 메시지를 확인하지 않고 중단합니다.</p> <h3 id="작업-실행-이력-task-execution-history"><a href="#작업-실행-이력-task-execution-history" class="header-anchor">#</a> 작업 실행 이력(Task execution history)</h3> <p>작업 실행 완료 후 워커는 작업 실행 이력을 기록합니다. <code>TaskExecutionHistory</code> 스키마는 다음과 같습니다.</p> <table><thead><tr><th>JobId</th> <th>StartTime</th> <th>CompletedTime</th> <th>Status</th> <th>RetryCount</th></tr></thead> <tbody></tbody></table> <h3 id="보고-서비스-reporting-service"><a href="#보고-서비스-reporting-service" class="header-anchor">#</a> 보고 서비스(Reporting Service)</h3> <p>보고 서비스는 <code>Jobs</code>와 <code>TaskExecutionHistory</code> 테이블을 사용해 사용자별 작업 상태를 표시합니다.</p> <h3 id="알림-및-모니터링-서비스-alerting-and-monitoring-service"><a href="#알림-및-모니터링-서비스-alerting-and-monitoring-service" class="header-anchor">#</a> 알림 및 모니터링 서비스(Alerting and monitoring service)</h3> <p>작업 실패율을 모니터링 시스템에 기록하고 조건에 따라 알림 규칙을 구성할 수 있습니다.</p> <h3 id="스케일링-작업-스케줄러-시스템-scale-job-scheduler-system"><a href="#스케일링-작업-스케줄러-시스템-scale-job-scheduler-system" class="header-anchor">#</a> 스케일링 작업 스케줄러 시스템(Scale job scheduler system)</h3> <p>사용자와 작업의 양에 따라 각 컴포넌트를 수평으로 확장할 수 있습니다. 저장소가 적절히 분할되어 있어 수평 확장이 용이합니다.</p> <hr> <p>reference: <a href="https://dilipkumar.medium.com/distributed-job-scheduler-system-design-8ae13a8dee83" target="_blank" rel="noopener noreferrer">Distributed Job Scheduler system design<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/TIL/design-pattern/241030-factory-decorator-pattern.html" class="prev">
        팩토리 패턴과 데코레이터 패턴
      </a></span> <span class="next"><a href="/TIL/mlops/241109-mlops-data-testing.html">
        MLOps 01: Data testing, why, what and how
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/TIL/assets/js/app.dba3423c.js" defer></script><script src="/TIL/assets/js/2.83a6f128.js" defer></script><script src="/TIL/assets/js/1.322c5a0a.js" defer></script><script src="/TIL/assets/js/29.f2c2a0c0.js" defer></script>
  </body>
</html>
