<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>도커 멀티스테이징 | Today I Learned</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="desc">
    
    <link rel="preload" href="/TIL/assets/css/0.styles.00bd70e4.css" as="style"><link rel="preload" href="/TIL/assets/js/app.dba3423c.js" as="script"><link rel="preload" href="/TIL/assets/js/2.83a6f128.js" as="script"><link rel="preload" href="/TIL/assets/js/1.322c5a0a.js" as="script"><link rel="preload" href="/TIL/assets/js/34.53302144.js" as="script"><link rel="prefetch" href="/TIL/assets/js/10.d9e4b84a.js"><link rel="prefetch" href="/TIL/assets/js/11.ccf2f442.js"><link rel="prefetch" href="/TIL/assets/js/12.7e65a11a.js"><link rel="prefetch" href="/TIL/assets/js/13.d4317b93.js"><link rel="prefetch" href="/TIL/assets/js/14.ea01d868.js"><link rel="prefetch" href="/TIL/assets/js/15.9da1bcf8.js"><link rel="prefetch" href="/TIL/assets/js/16.8727279f.js"><link rel="prefetch" href="/TIL/assets/js/17.fa7fb6b0.js"><link rel="prefetch" href="/TIL/assets/js/18.56419c05.js"><link rel="prefetch" href="/TIL/assets/js/19.42d46c09.js"><link rel="prefetch" href="/TIL/assets/js/20.100d0125.js"><link rel="prefetch" href="/TIL/assets/js/21.428690a9.js"><link rel="prefetch" href="/TIL/assets/js/22.53eda83e.js"><link rel="prefetch" href="/TIL/assets/js/23.377a507c.js"><link rel="prefetch" href="/TIL/assets/js/24.62a43f53.js"><link rel="prefetch" href="/TIL/assets/js/25.2cb61fbc.js"><link rel="prefetch" href="/TIL/assets/js/26.07decc26.js"><link rel="prefetch" href="/TIL/assets/js/27.51b2d4dd.js"><link rel="prefetch" href="/TIL/assets/js/28.86b66102.js"><link rel="prefetch" href="/TIL/assets/js/29.f2c2a0c0.js"><link rel="prefetch" href="/TIL/assets/js/3.e6df855e.js"><link rel="prefetch" href="/TIL/assets/js/30.33147ece.js"><link rel="prefetch" href="/TIL/assets/js/31.4cd27359.js"><link rel="prefetch" href="/TIL/assets/js/32.a6842c91.js"><link rel="prefetch" href="/TIL/assets/js/33.431c1871.js"><link rel="prefetch" href="/TIL/assets/js/35.d500be46.js"><link rel="prefetch" href="/TIL/assets/js/36.f4e6eb9f.js"><link rel="prefetch" href="/TIL/assets/js/37.eb0597c0.js"><link rel="prefetch" href="/TIL/assets/js/38.bcaf4fbf.js"><link rel="prefetch" href="/TIL/assets/js/39.c64a3043.js"><link rel="prefetch" href="/TIL/assets/js/4.cd02f05a.js"><link rel="prefetch" href="/TIL/assets/js/40.c4adbd8b.js"><link rel="prefetch" href="/TIL/assets/js/41.417973c2.js"><link rel="prefetch" href="/TIL/assets/js/42.c0d1a1f0.js"><link rel="prefetch" href="/TIL/assets/js/5.610977c8.js"><link rel="prefetch" href="/TIL/assets/js/6.b548e5bb.js"><link rel="prefetch" href="/TIL/assets/js/7.08600db3.js"><link rel="prefetch" href="/TIL/assets/js/vendors~docsearch.ef62c33d.js">
    <link rel="stylesheet" href="/TIL/assets/css/0.styles.00bd70e4.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/TIL/" class="home-link router-link-active"><!----> <span class="site-name">Today I Learned</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://github.com/jang-hs" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://github.com/jang-hs" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/TIL/" aria-current="page" class="sidebar-link">Monthly I Learned</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>algorithm</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>data-engineer</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>design-pattern</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>mlops</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/TIL/mlops/241109-mlops-data-testing.html" class="sidebar-link">MLOps 01: Data testing, why, what and how</a></li><li><a href="/TIL/mlops/241110-mlops-dagstar.html" class="sidebar-link">MLOps 02: Dagster — Seamless Data Pipelines &amp; ML Model Management for Machine Learning Engineers</a></li><li><a href="/TIL/mlops/241111-mlops-featurestore.html" class="sidebar-link">MLOps 03: Feast Feature Store — An In-depth Overview Experimentation and Application in Tabular data</a></li><li><a href="/TIL/mlops/241120-devops-metric-monitoring-alert.html" class="sidebar-link">Metrics Monitoring and Alerting system</a></li><li><a href="/TIL/mlops/241124-docker-multistage.html" aria-current="page" class="active sidebar-link">도커 멀티스테이징</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/TIL/mlops/241124-docker-multistage.html#멀티스테이징의-특징-및-목적" class="sidebar-link">멀티스테이징의 특징 및 목적</a></li><li class="sidebar-sub-header"><a href="/TIL/mlops/241124-docker-multistage.html#장점" class="sidebar-link">장점</a></li><li class="sidebar-sub-header"><a href="/TIL/mlops/241124-docker-multistage.html#사용-시-주의점" class="sidebar-link">사용 시 주의점</a></li><li class="sidebar-sub-header"><a href="/TIL/mlops/241124-docker-multistage.html#멀티스테이징-빌드-예제" class="sidebar-link">멀티스테이징 빌드 예제</a></li></ul></li><li><a href="/TIL/mlops/241125-devops-k8s-probe.html" class="sidebar-link">Kubernetes의 Probe 알아보기</a></li><li><a href="/TIL/mlops/241127-devops-k8s-hpa.html" class="sidebar-link">Kubernetes HPA (Horizontal Pod Autoscaler) 알아보기</a></li><li><a href="/TIL/mlops/250414-k8s-hard-way-01.html" class="sidebar-link">[k8s hard way] 01-prerequisites 실습</a></li><li><a href="/TIL/mlops/250415-k8s-hard-way-02.html" class="sidebar-link">[k8s hard way] 02-Jumpbox 설정</a></li><li><a href="/TIL/mlops/250725-gateway-httproute.html" class="sidebar-link">Gateway API와 HTTPRoute</a></li><li><a href="/TIL/mlops/250727-network-policy.html" class="sidebar-link">Kubernetes NetworkPolicy</a></li><li><a href="/TIL/mlops/250727-quota-limits.html" class="sidebar-link">LimitRange와 ResourceQuota</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>sql</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="도커-멀티스테이징"><a href="#도커-멀티스테이징" class="header-anchor">#</a> 도커 멀티스테이징</h1> <p>도커 멀티스테이징 빌드(Multi-stage Build)는 하나의 Dockerfile 내에서 여러개의 빌드 단계를 정의하여, 최종 이미지에 필요한 부분만 포함하도록 설계하는 기능입니다. 이를 통해 빌드 과정에서 필요한 도구나 라이브러리를 최종 이미지에 포함시키지 않아도 되므로, 효율적이고 관리하기 쉬운 컨테이너 이미지를 생성할 수 있습니다.</p> <p>전통적인 도커 빌드 방식에서는 애플리케이션을 빌드하기 위한 모든 도구와 라이브러리를 포함한 단일 이미지를 생성합니다. 이 경우, 최종 이미지에 불필요한 빌드 도구들이 포함되어 이미지 크기가 커지고 보안 취약점이 증가할 수 있습니다.</p> <p>멀티스테이지 빌드는 여러 개의 빌드 단계를 정의하여, 각 단계에서 필요한 작업을 수행한 후, 최종 단계에서는 필요한 아티팩트(예: 바이너리 파일, 컴파일된 코드 등)만을 가져와서 경량의 최종 이미지를 생성합니다. 이를 통해 빌드 환경과 실행 환경을 분리할 수 있습니다.</p> <h2 id="멀티스테이징의-특징-및-목적"><a href="#멀티스테이징의-특징-및-목적" class="header-anchor">#</a> <strong>멀티스테이징의 특징 및 목적</strong></h2> <ol><li><strong>효율성</strong> <ul><li>빌드와 실행을 위한 별도의 스테이지를 정의하여 빌드 중간에 생성되는 불필요한 파일이나 의존성을 최종 이미지에서 제외할 수 있습니다.</li></ul></li> <li><strong>이미지 크기 감소</strong> <ul><li>최종 실행 단계에서는 애플리케이션을 실행하는 데 필요한 파일만 포함하므로 최종 이미지의 크기가 줄어듭니다.</li></ul></li> <li><strong>보안 강화</strong> <ul><li>빌드 도구나 중간 단계에서 필요한 파일이 최종 이미지에 포함되지 않으므로 보안 취약점을 줄일 수 있습니다.</li></ul></li> <li><strong>유지보수성 향상</strong> <ul><li>Dockerfile이 단계별로 명확히 분리되므로 더 읽기 쉽고 관리하기 용이합니다.</li></ul></li></ol> <h2 id="장점"><a href="#장점" class="header-anchor">#</a> <strong>장점</strong></h2> <ul><li><strong>이미지 크기 최소화</strong> <ul><li>최종 이미지에 빌드 도구가 포함되지 않아 더 작고 경량화됩니다.</li> <li>예: <code>node:20-alpine</code>과 같이 경량 이미지만 포함 가능.</li> <li>최종 이미지는 최소한의 파일만 포함하므로 저장소 및 전송 비용 절감</li> <li>빌드 환경과 실행 환경을 분리하여 불필요한 의존성을 제거.</li></ul></li> <li><strong>보안 강화</strong> <ul><li>빌드 과정에서 사용된 민감한 정보(예: 환경 변수, 빌드 도구 등)가 실행 이미지에 포함되지 않음.</li></ul></li> <li>가독성 및 유지보수성
<ul><li>단계별로 빌드 과정을 명확히 정의하므로 Dockerfile이 더 이해하기 쉬워짐.</li> <li>빌드와 실행 환경을 분리하여 각각의 단계를 독립적으로 관리 가능.</li></ul></li> <li>다양한 환경 지원 및 성능 최적화
<ul><li>동일한 Dockerfile로 개발, 테스트, 프로덕션 환경에 맞는 이미지를 생성 가능.</li> <li>중간 빌드 단계에서 캐싱을 활용할 수 있어 빌드 속도 향상.</li></ul></li></ul> <h2 id="사용-시-주의점"><a href="#사용-시-주의점" class="header-anchor">#</a> <strong>사용 시 주의점</strong></h2> <ol><li><strong>캐시 활용</strong> <ul><li>빌드 과정에서 동일한 명령어 순서를 유지하여 캐시를 최대한 활용해야 효율적입니다.</li></ul></li> <li><strong>최소화된 베이스 이미지 선택</strong> <ul><li>최종 스테이지에서 불필요한 용량을 줄이기 위해 <code>alpine</code> 같은 경량 이미지를 사용하는 것이 좋습니다.</li></ul></li> <li><strong>중간 파일 제거</strong> <ul><li>빌드 단계에서 생성된 불필요한 파일이 최종 이미지로 넘어가지 않도록 관리.</li></ul></li></ol> <h2 id="멀티스테이징-빌드-예제"><a href="#멀티스테이징-빌드-예제" class="header-anchor">#</a> 멀티스테이징 빌드 예제</h2> <h3 id="동작-방식"><a href="#동작-방식" class="header-anchor">#</a> <strong>동작 방식</strong></h3> <ol><li><strong>여러 스테이지 정의</strong> <ul><li><code>FROM</code> 명령어를 여러 번 사용하여 각 스테이지를 정의합니다.</li> <li>이전 단계에서 생성된 파일을 다음 단계로 복사(<code>COPY</code>)하여 재사용합니다.</li></ul></li> <li><strong>최종 단계 선택</strong> <ul><li>마지막 스테이지에서 필요한 아티팩트(예: 실행 파일, 설정 파일)만 포함하여 최종 이미지를 만듭니다.</li></ul></li></ol> <h3 id="go-애플리케이션-예제"><a href="#go-애플리케이션-예제" class="header-anchor">#</a> <strong>Go 애플리케이션 예제</strong></h3> <div class="language-dockerfile extra-class"><pre class="language-dockerfile"><code><span class="token comment"># 1. 빌드 스테이지</span>
<span class="token instruction"><span class="token keyword">FROM</span> golang:1.20 <span class="token keyword">AS</span> builder</span>
<span class="token instruction"><span class="token keyword">WORKDIR</span> /app</span>
<span class="token instruction"><span class="token keyword">COPY</span> . .</span>
<span class="token instruction"><span class="token keyword">RUN</span> go build -o myapp .</span>

<span class="token comment"># 2. 실행 스테이지</span>
<span class="token instruction"><span class="token keyword">FROM</span> alpine:latest</span>
<span class="token instruction"><span class="token keyword">WORKDIR</span> /root/</span>
<span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">builder</span></span> /app/myapp .</span>
<span class="token instruction"><span class="token keyword">CMD</span> [<span class="token string">&quot;./myapp&quot;</span>]</span>
</code></pre></div><ul><li><strong><code>builder</code> 스테이지</strong>:
<ul><li>Go 애플리케이션을 빌드하는 데 필요한 Go 런타임과 빌드 도구를 포함합니다.</li> <li>결과물인 실행 파일(<code>myapp</code>)만 생성됩니다.</li></ul></li> <li><strong>최종 스테이지</strong>:
<ul><li>빌드 결과물(<code>myapp</code>)만 포함하고, Go 런타임이나 빌드 도구는 제외하여 이미지 크기를 최소화합니다.</li></ul></li></ul> <h3 id="node-js-애플리케이션-예제"><a href="#node-js-애플리케이션-예제" class="header-anchor">#</a> <strong>Node.js 애플리케이션 예제</strong></h3> <div class="language-dockerfile extra-class"><pre class="language-dockerfile"><code><span class="token comment"># 1. 빌드 스테이지</span>
<span class="token instruction"><span class="token keyword">FROM</span> node:20 <span class="token keyword">AS</span> builder</span>
<span class="token instruction"><span class="token keyword">WORKDIR</span> /app</span>
<span class="token instruction"><span class="token keyword">COPY</span> package*.json ./</span>
<span class="token instruction"><span class="token keyword">RUN</span> npm install</span>
<span class="token instruction"><span class="token keyword">COPY</span> . .</span>
<span class="token instruction"><span class="token keyword">RUN</span> npm run build</span>

<span class="token comment"># 2. 실행 스테이지</span>
<span class="token instruction"><span class="token keyword">FROM</span> nginx:alpine</span>
<span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">builder</span></span> /app/dist /usr/share/nginx/html</span>
</code></pre></div><ul><li><strong><code>builder</code> 스테이지</strong>:
<ul><li>Node.js와 npm을 사용하여 애플리케이션을 빌드합니다.</li> <li>빌드 결과물은 <code>/app/dist</code> 디렉토리에 생성됩니다.</li></ul></li> <li><strong>최종 스테이지</strong>:
<ul><li><code>nginx</code>를 사용하여 정적 파일을 서빙합니다.</li> <li>Node.js와 npm은 최종 이미지에 포함되지 않습니다.</li></ul></li></ul> <h3 id="java-애플리케이션-예제"><a href="#java-애플리케이션-예제" class="header-anchor">#</a> <strong>Java 애플리케이션 예제</strong></h3> <div class="language-dockerfile extra-class"><pre class="language-dockerfile"><code><span class="token comment"># 1. 빌드 스테이지</span>
<span class="token instruction"><span class="token keyword">FROM</span> maven:3.9 <span class="token keyword">AS</span> builder</span>
<span class="token instruction"><span class="token keyword">WORKDIR</span> /app</span>
<span class="token instruction"><span class="token keyword">COPY</span> pom.xml .</span>
<span class="token instruction"><span class="token keyword">COPY</span> src ./src</span>
<span class="token instruction"><span class="token keyword">RUN</span> mvn package</span>

<span class="token comment"># 2. 실행 스테이지</span>
<span class="token instruction"><span class="token keyword">FROM</span> openjdk:17</span>
<span class="token instruction"><span class="token keyword">WORKDIR</span> /app</span>
<span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">builder</span></span> /app/target/myapp.jar .</span>
<span class="token instruction"><span class="token keyword">CMD</span> [<span class="token string">&quot;java&quot;</span>, <span class="token string">&quot;-jar&quot;</span>, <span class="token string">&quot;myapp.jar&quot;</span>]</span>
</code></pre></div><ul><li><strong><code>builder</code> 스테이지</strong>:
<ul><li>Maven을 사용하여 Java 애플리케이션을 빌드하고 <code>.jar</code> 파일을 생성합니다.</li></ul></li> <li><strong>최종 스테이지</strong>:
<ul><li><code>openjdk</code> 이미지를 사용하여 <code>.jar</code> 파일만 실행합니다.</li></ul></li></ul> <p>도커 멀티스테이지 빌드를 활용하여 효율적이고 경량의 컨테이너 이미지를 생성할 수 있습니다. 빌드와 실행 환경을 명확히 분리하고, 이미지 크기를 최소화하며, 보안을 강화할 수 있습니다. 빌드 과정이 복잡해질 수 있으므로, 프로젝트의 요구사항에 따라 적절히 활용해야 합니다.</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/TIL/mlops/241120-devops-metric-monitoring-alert.html" class="prev">
        Metrics Monitoring and Alerting system
      </a></span> <span class="next"><a href="/TIL/mlops/241125-devops-k8s-probe.html">
        Kubernetes의 Probe 알아보기
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/TIL/assets/js/app.dba3423c.js" defer></script><script src="/TIL/assets/js/2.83a6f128.js" defer></script><script src="/TIL/assets/js/1.322c5a0a.js" defer></script><script src="/TIL/assets/js/34.53302144.js" defer></script>
  </body>
</html>
